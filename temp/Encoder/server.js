// server.js
const express = require('express');
const { createCanvas } = require('canvas');
const fetch = require('node-fetch');
const fs = require("fs");
const HttpsProxyAgent = require('https-proxy-agent');

const app = express();
app.use(express.json());


function createImageFile(name, base64String){
		
	// Remove metadata (if present)
	const base64Data = base64String.replace(/^data:image\/\w+;base64,/, "");
	
	// Write the file
	fs.writeFile(name, base64Data, { encoding: "base64" }, (err) => {
		if (err) {
			console.error("❌ Error saving image:", err);
		} else {
			console.log("✅ Image saved successfully:", name);
		}
	});
}




// Encode string digits into proper pixel data
function getEncodedPixelData(char) {
    let pixelData;
    switch (char) {
        case '0': pixelData = 0; break;
        case '1': pixelData = 1; break;
        case '2': pixelData = 2; break;
        case '3': pixelData = 3; break;
        case '4': pixelData = 4; break;
        case '5': pixelData = 5; break;
        case '6': pixelData = 6; break;
        case '7': pixelData = 7; break;
        case '8': pixelData = 8; break;
        case '9': pixelData = 9; break;
        case '.': pixelData = 10; break;
        case '-': pixelData = 11; break;
        case ',': pixelData = 12; break;
        case ';': pixelData = 13; break;
        default: pixelData = 15; break;
    }
    return pixelData;
}

// Decode pixel data into proper digits (string)
function getDecodedPixelData(rawPixelData) {
    let pixelData;
    switch (rawPixelData) {
        case 0: pixelData = '0'; break;
        case 1: pixelData = '1'; break;
        case 2: pixelData = '2'; break;
        case 3: pixelData = '3'; break;
        case 4: pixelData = '4'; break;
        case 5: pixelData = '5'; break;
        case 6: pixelData = '6'; break;
        case 7: pixelData = '7'; break;
        case 8: pixelData = '8'; break;
        case 9: pixelData = '9'; break;
        case 10: pixelData = '.'; break;
        case 11: pixelData = '-'; break;
        case 12: pixelData = ','; break;
        case 13: pixelData = ';'; break;
        default: pixelData = ' '; break;
    }
    return pixelData;
}


async function uploadImageToImgur(base64Image, accessToken, description) {
    const url = 'https://api.imgur.com/3/image';

    // Read image file as a Base64 encoded string (using FileReader)
    //const imageData = await fetch(imagePath).then(res => res.arrayBuffer());
    //const base64Image = btoa(String.fromCharCode(...new Uint8Array(imageData)));

    const postData = {
        description: description,
        image: base64Image.split(',')[1], // Base64-encoded image data
    };

    const headers = {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(postData)
        });

        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error uploading image:', error);
        return { success: false, error: error.message };
    }
}

async function addImageToImgurAlbum(imageId, albumId, accessToken) {
    const url = `https://api.imgur.com/3/album/${albumId}/add`;

    const postData = {
        ids: [imageId] // Array of image IDs to be added
    };

    const headers = {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json"
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(postData)
        });

        const result = await response.json();
        const httpCode = response.status;

        if (httpCode === 200) {
            return {
                success: true,
                data: result.data
            };
        } else {
            return {
                success: false,
                error: result.data.error || `HTTP ${httpCode}: Unknown error`,
                raw_response: result
            };
        }
    } catch (error) {
        console.error('Error adding image to album:', error);
        return { success: false, error: error.message };
    }
}

async function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

const fetchWithTimeout = (url, options, timeout = 10000) => {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Fetch timeout')), timeout))
    ]);
};















let tickers = [
    "CSWC",
    "CSWI",
    "CSX",
    "CTAS",
    "CTBI",
    "CTCX",
    "CTHR",
    "CTK",
    "CTKB",
    "CTLP",
    "CTMX",
    "CTNM",
    "CTNT",
    "CTO",
    "CTOR",
    "CTOS",
    "CTRA",
    "CTRE",
    "CTRI",
    "CTRM",
    "CTRN",
    "CTS",
    "CTSH",
    "CTSO",
    "CTVA",
    "CTXR",
    "CUB",
    "CUBE",
    "CUBI",
    "CUE",
    "CUEN",
    "CUK",
    "CULL",
    "CULP",
    "CURB",
    "CURI",
    "CURR",
    "CURV",
    "CUTR",
    "CUZ",
    "CVAC",
    "CVBF",
    "CVCO",
    "CVE",
    "CVEO",
    "CVGI",
    "CVGW",
    "CVI",
    "CVIA",
    "CVKD",
    "CVLG",
    "CVLT",
    "CVNA",
    "CVRX",
    "CVS",
    "CVV",
    "CVX",
    "CW",
    "CWAN",
    "CWBC",
    "CWCO",
    "CWD",
    "CWEN",
    "CWH",
    "CWK",
    "CWST",
    "CWT",
    "CX",
    "CXAI",
    "CXDO",
    "CXM",
    "CXT",
    "CXW",
    "CYAD",
    "CYAN",
    "CYBR",
    "CYCC",
    "CYCN",
    "CYCU",
    "CYD",
    "CYH",
    "CYN",
    "CYRX",
    "CYTH",
    "CYTK",
    "CZFS",
    "CZNC",
    "CZOOF",
    "CZR",
    "CZWI",
    /*"D",
    "DAC",
    "DADA",
    "DAIO",
    "DAKT",
    "DAL",
    "DALN",
    "DAN",
    "DAO",
    "DAR"*/
]

let jsonTickers = {};
let jsonImages = {};

const albumId = 'G0DQ6Hk'; // Imgur album ID
const accessToken = 'ffc8fd46eb1f0d2bf28d099af47f421eb574bfa3'; // Imgur access token

//tickers = ["IBM"]



// Proxy list
const proxyList = [

    "199.102.105.242:4145",
    "110.42.54.95:99",
    "188.165.179.23:1443",
    "123.30.154.171:7777",
    "171.237.121.209:1007",
    "43.153.98.107:13001",
    "98.181.137.80:4145",
    "49.51.248.107:13001",
    "134.209.29.120:80",
    "47.88.59.79:82",
    "43.153.16.223:13001",
    "185.254.97.49:3030",
    "79.127.158.225:8081",
    "159.65.230.46:8888",
    "142.54.236.97:4145",
    "49.51.242.102:13001",
    "43.153.32.146:13001",
    "38.156.238.67:999",
    "129.226.155.235:8080",
    "43.130.57.165:13001",
    "43.135.130.88:13001",
    "43.153.7.172:13001",
    "43.153.116.85:13001",
    "49.51.184.182:13001",
    "3.132.103.77:8082",
    "43.153.22.103:18088",
    "43.153.98.220:13001",
    "67.43.228.251:4077",
    "43.159.132.190:13001",
    "43.153.100.212:13001",
    "77.91.70.115:36748",
    "35.71.146.194:1688",
    "150.109.244.57:3808",
    "43.135.178.216:13001",
    "3.89.88.40:8080",
    "91.107.186.37:80",
    "43.152.72.7:13001",
    "49.51.193.30:13001",
    "49.76.17.159:8089",
    "218.85.5.108:597",
    "43.153.103.45:13001",
    "14.229.249.242:8080",
    "67.43.227.226:15837",
    "141.95.238.126:8080",
    "97.74.87.226:80",
    "49.51.41.61:13001",
    "170.106.99.182:13001",
    "159.203.61.169:8080",
    "4.175.200.138:8080",
    "103.237.144.232:1311",
    "47.254.28.155:8081",
    "170.106.194.126:13001",
    "43.153.117.193:13001",
    "188.203.37.74:8081",
    "202.51.196.226:8080",
    "78.46.212.196:1254",
    "43.130.47.163:13001",
    "98.175.31.195:4145",
    "43.135.184.36:13001",
    "93.127.215.97:80",
    "72.10.160.171:11117",
    "92.58.181.171:1194",
    "38.242.202.236:8080",
    "172.106.19.157:61243",
    "37.52.13.164:5678",
    "43.153.102.192:18088",
    "119.95.107.16:8081",
    "72.10.160.170:8925",
    "103.184.180.204:1313",
    "103.243.238.38:51772",
    "43.153.79.15:13001",
    "37.156.46.209:8080",
    "43.153.113.17:13001",
    "197.255.61.74:8080",
    "49.51.179.77:13001",
    "103.141.152.107:8989",
    "156.67.214.169:3128",
    "51.158.105.94:31826",
    "124.16.111.2:7890",
    "43.130.62.137:13001",
    "150.109.238.145:3808",
    "4.155.2.13:9401",
    "170.106.184.49:13001",
    "43.159.129.136:13001",
    "43.130.9.70:13001",
    "102.219.208.86:3346",
    "72.10.160.172:31115",
    "103.70.93.77:8097",
    "43.130.16.131:13001",
    "85.117.60.163:8080",
    "43.153.7.111:18088",
    "110.40.49.117:8888",
    "43.135.136.84:13001",
    "43.135.153.235:13001",
    "43.135.172.170:13001",
    "118.113.246.41:2324",
    "38.45.242.120:999",
    "38.171.255.28:8080",
    "8.220.204.92:19",
    "43.153.22.138:13001",
    "190.215.109.74:8080",
    "170.106.74.95:13001",
    "108.162.140.38:9876",
    "43.135.139.239:13001",
    "49.51.203.88:13001",
    "170.106.196.118:13001",
    "42.114.226.95:10006",
    "101.255.166.134:1111",
    "170.106.193.214:13001",
    "103.22.99.12:2020",
    "101.66.194.93:8085",
    "43.153.69.199:13001",
    "43.153.27.172:13001",
    "43.153.36.97:13001",
    "175.139.233.79:80",
    "23.247.136.248:80",
    "170.239.18.106:1830",
    "43.130.48.100:13001",
    "56.124.116.111:5050",
    "38.65.172.193:999",
    "181.209.107.154:999",
    "37.114.37.82:2019",
    "39.37.164.233:8080",
    "190.122.88.144:8080",
    "90.161.186.147:3128",
    "77.91.70.115:12977",
    "113.108.13.120:4433",
    "43.153.69.25:13001",
    "124.83.121.23:8082",
    "72.10.160.171:32073",
    "188.117.108.67:443",
    "59.53.80.122:10024",
    "5.75.197.16:10602",
    "170.106.192.157:13001",
    "103.61.16.8:8086",
    "103.87.148.16:8085",
    "42.117.155.246:8080",
    "170.106.141.8:13001",
    "43.130.39.183:13001",
    "203.76.151.50:49200",
    "143.42.66.91:80",
    "191.53.112.170:45619",
    "43.135.154.71:13001",
    "95.164.19.61:3228",
    "172.188.122.92:80",
    "67.43.227.226:21345",
    "189.22.234.40:80",
    "49.51.198.134:13001",
    "43.153.18.228:18088",
    "67.43.227.226:5957",
    "87.248.129.32:80",
    "181.39.9.173:999",
    "4.155.2.13:9443",
    "176.88.175.197:8080",
    "170.106.115.219:13001",
    "43.135.164.4:13001",
    "106.12.111.83:9103",
    "38.7.3.8:999",
    "170.106.117.195:13001",
    "113.108.13.120:8083",
    "43.159.136.60:13001",
    "103.13.204.46:8090",
    "41.65.227.183:1981",
    "59.37.95.35:8072",
    "79.127.158.225:8080",
    "171.4.23.95:8080",
    "43.153.107.74:13001",
    "43.153.8.210:13001",
    "43.153.118.161:13001",
    "54.37.214.253:80",
    "200.0.234.106:3128",
    "185.254.97.188:3030",
    "103.68.214.108:8080",
    "102.0.18.120:8080",
    "60.248.77.86:555",
    "165.165.241.190:8085",
    "67.43.228.250:25971",
    "43.153.48.129:13001",
    "202.61.204.51:80",
    "103.82.36.183:8888",
    "103.148.44.99:8080",
    "103.97.140.119:3125",
    "61.186.243.6:9002",
    "43.153.4.125:13001",
    "92.255.196.217:39914",
    "43.153.98.70:13001",
    "43.130.2.135:13001",
    "43.130.17.73:13001",
    "202.96.46.200:8010",
    "38.242.215.226:8888",
    "223.25.110.120:1095",
    "43.153.35.252:13001",
    "122.154.129.2:8080",
    "70.39.116.195:20002",
    "188.166.230.109:31028",
    "43.153.69.148:18088",
    "181.168.88.76:8080",
    "170.106.153.126:13001",
    "180.114.169.240:8089",
    "119.92.75.252:8181",
    "114.231.72.60:1080",
    "135.181.154.225:80",
    "103.233.152.18:8080",
    "184.178.172.14:4145",
    "45.92.177.60:8080",
    "170.106.116.169:17981",
    "49.51.179.85:13001",
    "47.83.192.255:8888",
    "212.252.73.29:8080",
    "197.96.157.93:8080",
    "94.24.236.42:8080",
    "43.130.32.94:13001",
    "43.153.14.194:13001",
    "221.202.27.194:10809",
    "43.153.28.45:13001",
    "38.254.108.1:999",
    "188.117.108.67:80",
    "170.106.184.19:13001",
    "170.106.80.237:13001",
    "67.43.236.19:25687",
    "89.36.65.133:3128",
    "43.135.149.15:13001",
    "43.203.29.133:3128",
    "203.177.133.235:8080",
    "8.218.14.185:1088",
    "27.189.128.251:8089",
    "43.153.103.58:13001",
    "43.135.179.240:13001",
    "43.130.61.237:13001",
    "188.68.52.220:9050",
    "154.9.247.134:56789",
    "188.117.108.68:80",
    "45.252.183.245:5619",
    "49.51.245.200:13001",
    "165.225.72.38:10801",
    "176.88.175.171:8080",
    "170.106.173.254:13001",
    "43.130.37.196:13001",
    "103.249.86.48:3128",
    "185.138.120.109:8080",
    "43.135.138.21:13001",
    "43.135.172.149:13001",
    "43.153.66.252:13001",
    "49.51.202.75:13001",
    "212.252.71.9:8080",
    "170.106.198.32:13001",
    "15.235.10.31:28003",
    "8.213.215.187:8008",
    "186.216.179.109:48179",
    "109.94.228.146:3128",
    "200.125.170.234:999",
    "114.199.109.10:8080",
    "43.153.4.199:13001",
    "165.16.92.193:8103",
    "188.166.197.129:3128",
    "157.20.253.173:8080",
    "67.43.236.21:15401",
    "38.183.146.153:8787",
    "165.16.55.19:44444",
    "115.34.114.178:1080",
    "112.64.155.147:1088",
    "103.20.85.106:7643",
    "103.247.23.73:8081",
    "188.117.108.66:443",
    "14.204.53.131:8085",
    "45.123.142.42:8181",
    "41.173.7.82:8080",
    "103.247.21.55:4598",
    "168.196.112.249:56000",
    "103.133.27.239:8080",
    "43.153.23.64:13001",
    "58.243.224.244:8085",
    "23.82.137.159:80",
    "171.239.80.133:554",
    "43.130.11.212:13001",
    "43.135.164.2:13001",
    "4.155.2.13:9400",
    "3.94.92.40:8080",
    "114.9.26.202:8080",
    "105.28.176.41:9812",
    "42.114.226.95:10007",
    "43.153.22.230:13001",
    "8.219.97.248:80",
    "121.236.236.15:8089",
    "85.117.60.131:8080",
    "103.192.159.57:8080",
    "63.143.57.120:80",
    "67.43.227.226:5673",
    "43.153.105.141:13001",
    "170.106.183.91:13001",
    "43.159.139.11:3080",
    "103.80.110.190:80",
    "42.113.88.191:8080",
    "43.130.0.130:13001",
    "43.153.23.198:13001",
    "49.0.87.62:8080",
    "67.43.228.254:27637",
    "213.239.221.24:8888",
    "43.153.88.171:13001",
    "49.48.44.232:8080",
    "43.153.26.163:13001",
    "65.20.189.104:9090",
    "43.155.196.88:9090",
    "38.152.65.71:2335",
    "43.135.132.181:13001",
    "43.135.130.198:13001",
    "103.247.21.116:1111",
    "149.129.251.31:3128",
    "171.237.122.99:1008",
    "177.234.247.234:999",
    "217.169.211.82:6666",
    "49.51.75.54:13001",
    "121.232.178.21:8089",
    "103.97.140.177:8080",
    "103.167.170.186:6767",
    "189.22.234.32:80",
    "154.64.219.61:8888",
    "45.228.235.10:999",
    "103.155.168.50:8299",
    "170.106.106.9:13001",
    "49.51.201.67:13001",
    "43.159.138.46:13001",
    "43.153.18.198:13001",
    "157.10.97.119:8181",
    "121.227.118.142:8089",
    "43.153.61.52:13001",
    "190.109.1.34:999",
    "45.140.143.77:18080",
    "186.207.148.71:8787",
    "190.71.174.227:999",
    "189.22.234.33:80",
    "103.139.243.137:83",
    "27.189.133.236:8089",
    "80.249.112.162:80",
    "103.188.252.28:8080",
    "47.56.110.204:8989",
    "188.132.150.78:8080",
    "138.68.235.51:80",
    "212.111.89.182:443",
    "200.250.131.218:80",
    "71.14.238.14:80",
    "170.106.198.54:13001",
    "189.201.153.93:999",
    "139.59.1.14:80",
    "1.32.48.212:8081",
    "43.135.137.152:13001",
    "103.167.4.10:8080",
    "41.47.207.27:8080",
    "45.129.141.143:3128",
    "49.51.33.115:13001",
    "170.106.64.217:13001",
    "43.248.101.232:9999",
    "170.106.107.101:13001",
    "103.173.141.9:8080",
    "201.20.67.70:8080",
    "77.221.141.36:53647",
    "103.136.82.252:83",
    "67.43.227.226:32457",
    "43.135.148.218:13001",
    "49.51.182.56:13001",
    "72.10.160.170:8321",
    "170.106.140.154:13001",
    "49.51.75.240:13001",
    "103.39.51.156:8089",
    "38.51.243.81:999",
    "49.51.207.251:13001",
    "103.247.13.131:8080",
    "47.56.110.204:8990",
    "189.50.9.30:8080",
    "43.203.244.142:7188",
    "8.220.204.215:808",
    "170.106.137.158:13001",
    "183.162.197.197:8060",
    "47.238.134.126:9080",
    "170.106.64.187:13001",
    "103.36.11.183:8080",
    "8.220.204.215:3128",
    "138.0.60.19:1080",
    "8.215.3.250:8443",
    "103.155.246.42:8080",
    "43.130.17.84:13001",
    "89.221.215.128:80",
    "8.220.204.215:80",
    "38.123.220.16:8080",
    "170.106.67.179:13001",
    "101.255.118.9:3127",
    "43.153.42.39:13001",
    "219.152.175.168:10040",
    "36.95.82.69:8080",
    "81.169.213.169:8888",
    "154.85.58.149:80",
    "43.153.48.105:13001",
    "58.64.12.11:8081",
    "176.9.239.181:80",
    "43.153.45.169:13001",
    "219.92.203.20:8080",
    "67.43.236.18:16443",
    "43.153.94.8:13001",
    "201.91.82.155:3128",
    "49.51.73.61:13001",
    "170.106.73.178:13001",
    "117.74.65.207:443",
    "179.60.53.28:999",
    "43.130.2.57:13001",
    "37.220.83.160:37895",
    "77.243.15.85:3246",
    "197.248.37.177:8104",
    "8.215.3.250:41",
    "114.231.73.58:8089",
    "118.179.136.69:47417",
    "181.143.59.140:4153",
    "103.158.126.65:3888",
    "23.82.137.156:80",
    "217.24.245.58:8079",
    "8.217.74.245:3228",
    "218.75.224.4:3309",
    "170.106.83.149:13001",
    "103.153.62.155:8080",
    "43.133.136.208:8800",
    "43.153.14.2:13001",
    "38.172.129.160:999",
    "186.115.202.103:8080",
    "182.253.112.194:8080",
    "43.153.92.210:13001",
    "101.71.143.237:8092",
    "165.16.92.193:8104",
    "190.52.100.195:999",
    "162.223.90.130:80",
    "23.94.214.182:5448",
    "43.135.131.121:13001",
    "171.237.121.209:1027",
    "47.90.205.231:33333",
    "59.173.28.192:8118",
    "8.134.149.133:8081",
    "212.83.143.204:48648",
    "103.249.117.180:3128",
    "103.247.23.28:9223",
    "43.130.29.139:13001",
    "125.26.204.97:8080",
    "49.51.249.217:13001",
    "114.224.221.10:8089",
    "18.163.90.139:8001",
    "103.44.12.22:8080",
    "43.159.149.62:13001",
    "52.22.60.110:100",
    "36.74.120.240:8080",
    "43.153.46.52:13001",
    "43.153.16.91:13001",
    "54.84.138.185:8080",
    "43.153.92.75:13001",
    "46.232.120.33:5432",
    "71.14.218.2:8080",
    "14.224.218.210:8080",
    "45.174.95.242:8080",
    "124.167.20.190:8060",
    "43.153.39.191:13001",
    "12.7.109.1:9812",
    "162.214.102.195:60891",
    "43.135.183.46:13001",
    "15.235.10.43:28003",
    "51.75.206.209:80",
    "122.53.59.191:5050",
    "168.121.242.66:999",
    "77.77.210.90:21056",
    "78.108.108.9:8080",
    "43.153.2.3:13001",
    "103.40.121.88:8189",
    "221.231.13.198:1080",
    "188.117.108.66:80",
    "43.153.99.175:13001",
    "1.179.231.130:8080",
    "67.43.236.19:32487",
    "103.173.138.252:8080",
    "67.43.236.19:31147",
    "38.172.131.228:999",
    "175.100.98.190:8080",
    "49.51.72.228:13001",
    "43.153.27.33:13001",
    "222.74.73.202:42055",
    "43.153.11.82:13001",
    "190.128.195.58:999",
    "119.3.113.151:9094",
    "160.19.18.223:7777",
    "189.22.234.35:80",
    "43.153.91.13:13001",
    "195.114.209.50:80",
    "27.189.132.42:8089",
    "38.152.65.84:2335",
    "118.99.123.232:8888",
    "79.127.158.225:8082",
    "117.5.58.130:30549",
    "54.84.197.157:8080",
    "43.153.100.6:13001",
    "43.130.2.30:13001",
    "72.10.160.170:1499",
    "43.135.134.89:13001",
    "49.48.177.11:8080",
    "43.130.58.21:13001",
    "191.252.204.220:8080",
    "38.54.71.67:80",
    "219.135.229.197:7890",
    "13.213.51.24:8080",
    "38.65.174.10:999",
    "189.156.201.180:999",
    "117.0.91.207:10009",
    "172.167.161.8:8080",
    "43.153.79.9:13001",
    "183.240.46.42:80",
    "119.3.113.152:9094",
    "149.34.215.170:3333",
    "187.202.210.3:3128",
    "103.66.169.252:8080",
    "27.79.245.82:16000",
    "43.153.96.48:18088",
    "49.51.38.113:13001",
    "8.218.150.36:38080",
    "45.191.7.249:8080",
    "185.254.96.22:3030",
    "103.108.131.2:8080",
    "38.154.15.63:2335",
    "41.216.42.170:8080",
    "103.234.124.133:8181",
    "190.12.95.170:47029",
    "94.105.62.240:8081",
    "43.153.94.60:13001",
    "43.135.134.152:13001",
    "43.129.201.43:443",
    "77.221.141.93:6060",
    "200.174.198.86:8888",
    "31.31.0.74:3128",
    "43.135.166.98:13001",
    "208.43.38.57:3128",
    "170.106.117.36:13001",
    "85.208.114.131:8080",
    "38.156.14.196:999",
    "49.88.62.119:1080",
    "171.237.119.11:1008",
    "168.227.10.228:8080",
    "190.103.177.131:80",
    "41.33.203.115:1982",
    "190.94.198.68:999",
    "38.183.146.170:8090",
    "74.136.151.208:20",
    "108.181.132.117:43919",
    "1.94.209.207:2022",
    "8.213.137.155:389",
    "158.255.77.169:80",
    "61.164.204.130:4999",
    "103.126.119.246:8080",
    "159.203.61.169:3128",
    "43.153.118.253:13001",
    "89.189.158.250:8080",
    "38.22.90.124:8888",
    "187.245.214.11:999",
    "80.249.112.166:80",
    "27.74.247.173:8080",
    "124.83.121.91:8082",
    "123.13.218.68:9002",
    "103.63.26.119:8080",
    "170.106.181.226:13001",
    "51.254.78.223:80",
    "142.93.202.130:3128",
    "217.160.224.54:8118",
    "4.145.89.88:8080",
    "2.138.49.5:3128",
    "34.87.84.105:80",
    "101.255.149.202:8080",
    "34.205.30.237:8080",
    "103.154.77.35:9090",
    "43.130.42.164:13001",
    "27.189.135.59:8089",
    "103.193.144.5:8082",
    "111.72.129.42:2324",
    "103.188.252.162:8080",
    "185.26.201.73:8080",
    "72.10.160.171:1499",
    "49.51.197.116:13001",
    "103.247.23.181:4319",
    "59.98.3.132:8042",
    "119.3.113.150:9094",
    "170.106.170.175:13001",
    "171.237.122.99:1030",
    "200.37.252.122:8080",
    "8.215.12.103:8009",
    "142.171.85.100:800",
    "91.214.31.234:8080",
    "192.46.229.201:3310",
    "157.15.82.118:8080",
    "27.189.135.56:8089",
    "218.77.183.214:5224",
    "49.51.35.214:13001",
    "160.191.180.159:7777",
    "54.37.214.253:8080",
    "38.65.172.3:999",
    "8.215.12.103:8888",
    "117.74.65.207:80",
    "148.72.23.56:56504",
    "103.165.64.86:4153",
    "213.149.156.87:5678",
    "195.140.226.32:5678",
    "37.187.73.7:62148",
    "118.172.47.97:51327",
    "190.104.143.94:4153",
    "144.76.98.208:25611",
    "91.192.25.158:4145",
    "128.195.58.177:8081",
    "175.158.40.224:2020",
    "67.213.212.53:19932",
    "118.68.114.73:10003",
    "98.170.57.231:4145",
    "36.6.139.19:38801",
    "108.181.6.117:48950",
    "177.129.249.170:8080",
    "162.214.197.102:42256",
    "14.102.152.142:3127",
    "95.178.108.189:5678",
    "92.205.60.110:55539",
    "185.105.102.179:80",
    "178.171.88.22:5433",
    "66.42.224.229:41679",
    "103.159.96.121:8080",
    "50.96.204.50:18351",
    "173.212.237.43:25123",
    "207.244.229.34:24445",
    "51.83.116.2:55147",
    "72.195.34.42:4145",
    "79.106.231.17:8080",
    "102.220.13.208:8080",
    "156.193.193.191:80",
    "92.204.134.38:54467",
    "103.233.2.90:4893",
    "187.44.211.118:4153",
    "47.90.167.27:8081",
    "98.188.47.150:4145",
    "103.127.23.10:5678",
    "206.171.59.47:80",
    "45.134.79.45:10476",
    "105.214.69.228:5678",
    "60.189.98.245:38801",
    "89.58.45.94:32901",
    "103.159.96.141:8080",
    "103.159.96.95:8080",
    "100.42.112.23:3128",
    "14.207.78.15:4153",
    "185.130.219.12:4153",
    "8.148.23.165:8081",
    "15.235.132.246:8080",
    "103.159.96.146:3128",
    "67.43.236.18:22089",
    "45.142.193.36:4359",
    "221.224.140.140:51080",
    "179.125.172.177:4153",
    "86.110.189.154:4145",
    "111.132.16.97:3389",
    "122.252.128.19:80",
    "5.8.240.94:4153",
    "162.241.6.97:63239",
    "27.189.135.108:8089",
    "192.111.137.37:18762",
    "168.227.158.41:4145",
    "186.251.255.65:31337",
    "103.232.20.162:3127",
    "202.93.247.42:8080",
    "143.137.148.112:5678",
    "191.230.115.244:21145",
    "191.102.248.42:4153",
    "183.6.57.161:5678",
    "64.202.186.2:30443",
    "45.142.193.35:12132",
    "78.46.212.196:1021",
    "123.205.24.240:8193",
    "89.58.45.94:43476",
    "185.208.148.177:43596",
    "76.88.2.190:6515",
    "67.43.227.228:20319",
    "67.43.228.250:25775",
    "49.36.71.132:40006",
    "192.252.215.5:16137",
    "192.210.148.89:80",
    "114.91.26.39:2324",
    "23.225.71.36:26757",
    "122.77.72.34:80",
    "64.187.232.70:5355",
    "49.75.223.92:8989",
    "201.128.32.136:1524",
    "192.252.220.92:17328",
    "120.209.251.129:8888",
    "36.67.88.77:4153",
    "39.104.23.154:9080",
    "23.105.170.30:61519",
    "212.83.137.150:36054",
    "54.127.52.127:1080",
    "124.160.173.7:3128",
    "124.216.181.12:8081",
    "191.98.195.250:4145",
    "152.53.36.109:34906",
    "36.66.170.25:4153",
    "121.224.156.152:8089",
    "72.10.164.178:25833",
    "49.87.172.125:1080",
    "122.252.179.66:5678",
    "98.170.57.249:4145",
    "109.58.221.190:3128",
    "189.50.138.10:5678",
    "188.213.34.150:11512",
    "102.82.244.194:8080",
    "135.197.28.48:3128",
    "38.170.169.117:5358",
    "222.67.12.109:2324",
    "7.255.66.240:8080",
    "107.173.197.142:3128",
    "138.199.159.231:3000",
    "181.39.12.230:999",
    "41.75.85.22:8080",
    "8.130.39.117:21025",
    "195.24.73.187:80",
    "85.17.107.85:537",
    "212.83.143.60:53397",
    "77.238.79.111:5678",
    "103.153.77.159:12345",
    "222.67.13.25:2324",
    "139.255.75.230:3128",
    "21.153.194.208:1080",
    "114.91.25.38:1080",
    "213.252.245.221:6120",
    "167.172.159.43:1162",
    "134.236.58.204:8080",
    "72.10.164.178:6763",
    "50.63.12.101:45801",
    "47.91.110.148:3128",
    "168.221.170.122:8080",
    "201.151.53.211:999",
    "199.102.104.70:4145",
    "88.42.237.102:8080",
    "74.65.28.247:8080",
    "12.232.160.63:3128",
    "180.147.220.31:1337",
    "67.43.228.250:30251",
    "156.248.107.93:6400",
    "192.99.207.129:26567",
    "109.224.22.36:51372",
    "207.180.198.241:47936",
    "202.131.235.138:4153",
    "147.54.240.216:8080",
    "194.5.237.238:16856",
    "111.132.16.69:3389",
    "180.180.124.248:49992",
    "82.9.81.182:80",
    "169.255.136.8:60279",
    "103.167.170.22:1111",
    "148.72.212.198:30066",
    "14.207.202.244:8080",
    "162.240.72.139:33019",
    "149.28.132.92:25820",
    "45.249.78.177:5678",
    "67.43.228.253:21383",
    "94.24.182.61:1080",
    "77.225.198.220:4673",
    "186.208.139.196:8080",
    "72.10.160.90:10591",
    "195.2.74.19:9621",
    "30.206.234.79:3128",
    "198.8.94.174:39078",
    "36.255.211.1:55438",
    "103.124.196.130:8080",
    "192.111.138.29:4145",
    "115.74.10.31:10017",
    "31.200.114.82:8080",
    "184.178.172.5:15303",
    "111.132.16.156:3389",
    "213.252.245.221:6116",
    "72.10.160.90:27847",
    "186.251.255.105:31337",
    "111.132.16.70:3389",
    "31.10.63.215:6708",
    "251.235.75.27:512",
    "80.154.30.163:80",
    "45.128.133.209:1080",
    "45.191.47.12:999",
    "67.213.212.49:44381",
    "188.247.61.234:8080",
    "222.247.57.67:9002",
    "47.243.50.83:8082",
    "24.249.199.4:4145",
    "67.213.212.57:62486",
    "171.41.130.174:2324",
    "8.220.204.92:8008",
    "38.66.207.9:999",
    "186.166.138.5:999",
    "199.187.210.54:4145",
    "2.59.117.122:46738",
    "154.53.91.255:8800",
    "37.210.148.244:8001",
    "72.195.34.60:27391",
    "72.10.160.91:13993",
    "210.233.4.137:110",
    "216.43.230.95:8081",
    "121.177.154.16:3128",
    "38.91.107.2:23110",
    "192.53.126.207:10137",
    "159.223.71.71:50837",
    "67.213.212.57:57243",
    "132.22.40.2:8080",
    "201.184.239.75:5678",
    "162.0.220.218:54748",
    "154.16.112.204:57616",
    "67.43.228.250:9761",
    "47.237.92.86:86",
    "2.187.234.221:8080",
    "58.219.241.53:3389",
    "27.71.162.157:4003",
    "181.174.228.34:999",
    "148.66.130.53:19007",
    "5.8.240.91:4153",
    "185.191.165.28:1080",
    "41.223.234.116:37259",
    "117.67.64.70:38801",
    "108.175.23.1:13135",
    "41.174.132.82:5678",
    "95.216.29.208:13082",
    "173.211.69.29:6622",
    "80.251.158.130:3128",
    "149.28.140.151:14224",
    "5.161.98.204:20703",
    "103.114.106.229:5663",
    "141.95.160.178:47709",
    "11.78.176.53:5566",
    "191.102.89.94:3128",
    "181.146.138.115:80",
    "186.195.33.22:5151",
    "185.132.1.221:4145",
    "189.68.43.66:8080",
    "67.205.177.122:32264",
    "89.38.97.145:12208",
    "222.67.13.78:2324",
    "75.119.145.154:12416",
    "93.127.163.52:80",
    "1.32.57.85:5678",
    "209.159.153.22:61949",
    "2.63.255.183:8080",
    "65.49.2.84:39807",
    "88.135.68.21:59274",
    "5.58.47.25:3629",
    "37.229.122.18:8080",
    "161.123.33.135:6158",
    "67.205.149.230:3128",
    "190.109.72.17:33633",
    "8.213.137.155:999",
    "222.68.37.97:1080",
    "163.207.253.45:5060",
    "8.213.134.213:8080",
    "82.223.151.8:53347",
    "188.125.169.215:10820",
    "201.234.24.89:4153",
    "119.18.158.130:4153",
    "45.234.83.248:8080",
    "87.98.129.60:20285",
    "103.160.182.33:8080",
    "74.208.51.197:5000",
    "46.173.175.166:10801",
    "83.66.20.224:1080",
    "38.54.101.254:8060",
    "125.87.82.171:2324",
    "103.156.17.240:8080",
    "111.132.16.238:3389",
    "38.240.45.111:3128",
    "103.145.34.150:1111",
    "178.153.241.108:8080",
    "222.68.36.181:2324",
    "94.141.99.147:3128",
    "38.65.172.4:999",
    "102.222.51.105:8080",
    "206.85.9.134:8080",
    "45.86.6.62:8080",
    "200.63.107.118:8089",
    "117.54.156.245:8080",
    "222.67.12.131:2324",
    "222.68.37.224:2324",
    "222.68.36.252:2324",
    "222.68.40.126:2324",
    "222.68.37.112:1080",
    "222.67.10.71:2324",
    "94.249.221.93:49200",
    "196.0.111.194:34638",
    "196.204.83.237:1976",
    "103.51.205.20:8080",
    "49.86.49.241:8888",
    "186.96.97.180:999",
    "111.72.193.66:2324",
    "37.26.86.206:47464",
    "103.168.254.33:8080",
    "14.143.130.210:80",
    "103.112.144.29:8118",
    "182.204.182.78:1080",
    "38.137.252.7:999",
    "103.176.96.172:1565",
    "46.64.137.233:80",
    "103.52.144.110:8021",
    "190.152.5.17:39888",
    "111.132.16.13:3389",
    "103.176.96.185:8082",
    "194.150.71.0:7060",
    "222.68.37.75:1080",
    "103.169.139.13:8081",
    "49.0.43.238:39930",
    "157.20.98.74:1111",
    "49.71.105.203:8888",
    "45.119.55.157:3128",
    "190.95.132.189:999",
    "103.126.87.144:8081",
    "196.251.222.233:8083",
    "222.67.8.254:1080",
    "103.171.245.165:1080",
    "118.113.245.112:2324",
    "114.91.25.59:1080",
    "196.204.83.228:1976",
    "222.68.40.59:2324",
    "190.60.44.234:999",
    "164.163.73.69:999",
    "36.90.25.181:8080",
    "180.74.171.206:8080",
    "103.134.222.186:8080",
    "103.235.152.170:57413",
    "45.149.93.123:9999",
    "222.70.146.212:1080",
    "203.161.30.139:8070",
    "103.30.181.182:8080",
    "141.11.241.127:8080",
    "103.243.177.129:8080",
    "222.67.12.40:1080",
    "222.67.12.185:1080",
    "114.91.24.229:1080",
    "45.70.236.194:999",
    "5.10.248.107:80",
    "202.136.89.142:27503",
    "141.136.56.104:999",
    "172.232.121.132:8080",
    "103.145.132.16:8080",
    "111.72.198.12:2324",
    "182.204.181.77:1080",
    "94.249.220.135:49200",
    "222.67.8.128:1080",
    "103.67.84.146:8080",
    "186.148.31.19:999",
    "103.160.41.65:8080",
    "222.67.15.76:1080",
    "222.67.8.205:1080",
    "157.66.16.42:8070",
    "222.68.38.82:2324",
    "222.68.37.46:2324",
    "222.68.39.0:2324",
    "222.68.38.14:1080",
    "117.3.64.126:10001",
    "172.235.29.87:8080",
    "27.147.175.115:8080",
    "209.97.163.81:8888",
    "103.190.60.28:9090",
    "114.91.25.83:1080",
    "61.174.243.28:10916",
    "103.148.130.6:8080",
    "43.249.143.166:8080",
    "203.111.253.103:8080",
    "102.222.62.111:8080",
    "102.213.241.70:8080",
    "154.73.29.129:8080",
    "103.149.238.106:8080",
    "182.204.180.146:1080",
    "45.86.6.137:8080",
    "103.154.25.126:8080",
    "179.107.159.103:8080",
    "103.48.70.81:83",
    "222.70.145.9:1080",
    "222.68.37.254:2324",
    "222.68.38.115:1080",
    "200.10.30.129:999",
    "103.245.205.226:6969",
    "103.126.87.112:3030",
    "182.204.179.34:1080",
    "41.65.236.47:1976",
    "222.68.42.88:1080",
    "222.68.41.137:2324",
    "154.65.39.7:80",
    "154.65.39.8:80",
    "148.230.195.165:6969",
    "2.179.193.146:80",
    "188.132.150.37:8080",
    "36.77.217.161:8081",
    "81.62.179.218:5472",
    "185.105.102.189:80",
    "111.72.194.201:2324",
    "197.232.85.163:8080",
    "103.179.252.167:8181",
    "103.191.115.252:82",
    "181.78.21.74:999",
    "181.78.21.38:999",
    "103.147.246.185:3127",
    "38.159.227.130:999",
    "222.68.36.25:1080",
    "182.204.182.147:1080",
    "69.49.228.101:3128",
    "103.219.75.2:8080",
    "115.147.63.59:8081",
    "36.72.23.92:8080",
    "103.169.255.196:6080",
    "103.133.26.75:8181",
    "160.22.22.89:3125",
    "222.68.36.49:1080",
    "36.37.224.125:8080",
    "2.186.114.66:8080",
    "177.72.156.75:8080",
    "216.158.246.90:51012",
    "38.255.23.131:999",
    "78.28.152.111:80",
    "103.158.162.18:8080",
    "27.79.194.186:16000",
    "45.115.253.30:83",
    "103.165.157.248:8090",
    "58.187.175.215:16000",
    "27.79.248.34:16000",
    "161.97.136.251:3128",
    "103.162.54.203:8080",
    "186.26.92.180:58339",
    "103.247.23.181:1111",
    "27.79.164.240:16000",
    "119.2.48.12:9669",
    "41.40.175.222:8080",
    "27.79.239.226:16000",
    "41.220.138.246:8040",
    "111.132.16.22:3389",
    "27.79.156.251:16000",
  
  
  
    "72.10.160.90:8985",
    "43.207.50.162:20202",
    "56.155.28.22:20202",
    "43.153.92.230:18088",
    "43.156.166.147:443",
    "4.145.89.88:8080",
    "170.106.99.182:13001",
    "35.72.118.126:80",
    "43.135.134.152:13001",
    "43.135.136.84:13001",
    "43.153.46.52:13001",
    "49.51.35.214:13001",
    "43.130.29.139:13001",
    "195.158.8.123:3128",
    "43.153.112.28:13001",
    "43.130.32.94:13001",
    "43.135.132.181:13001",
    "49.51.207.251:13001",
    "49.51.73.74:13001",
    "170.106.140.86:13001",
    "43.130.47.163:13001",
    "49.51.179.77:13001",
    "43.135.148.218:13001",
    "49.51.182.56:13001",
    "49.51.70.77:13001",
    "43.153.25.42:13001",
    "43.153.4.199:13001",
    "13.55.192.34:20202",
    "99.79.64.51:20201",
    "54.252.193.7:20201",
    "13.201.193.31:20202",
    "3.128.90.170:20202",
    "13.245.229.158:20201",
	
    "43.153.69.192:18088",
    "13.37.89.201:80",
    "91.121.41.227:10101",
    "13.36.104.85:80",
    "15.236.106.236:3128",
    "203.115.101.51:82",
    "31.44.91.218:8080",
    "43.153.112.28:13001",
    "117.0.91.207:10007",
    "43.130.62.137:13001",
    "170.106.143.168:13001",
    "49.51.203.88:13001",
    "43.130.3.92:13001",
    "170.106.107.197:13001",
    "49.51.75.54:13001",
    "43.135.129.111:13001",
    "170.106.198.32:13001",
    "43.135.134.152:13001",
    "43.135.186.145:13001",
    "170.106.110.139:13001",
    "43.159.138.46:13001",
    "51.91.237.124:8080",
    "43.130.0.130:13001",
    "43.135.179.240:13001",







	"http://170.106.73.178:13001",
	"http://170.106.168.138:13001",
	"http://170.106.100.130:13001",
	"http://43.135.177.23:13001",
	"http://43.135.139.239:13001",
	"http://170.106.67.179:13001",
	"http://170.106.99.182:13001",
	"http://43.135.129.111:13001",
	"http://182.72.203.255:80",
	"http://170.106.106.9:13001",
	"http://170.106.196.118:13001",
	"http://170.106.140.86:13001",
	"http://170.106.80.237:13001",
	"http://170.106.153.126:13001",
	"http://43.135.130.124:13001",



	"http://38.177.103.132:8899",
	"http://38.177.105.35:8899",
	"http://47.251.122.81:8888",
	"http://85.214.107.177:80",
	"http://158.255.77.169:80",
	"http://118.27.111.97:80",
	
	"http://50.207.199.80:80",
	"http://50.207.199.83:80",
	"http://50.174.7.153:80",
	"http://50.202.75.26:80",
	"http://50.239.72.18:80",
	"http://50.221.74.130:80",
	"http://50.175.212.74:80",
	"http://50.207.199.82:80",
	"http://50.174.7.152:80",
	"http://71.14.218.2:8080",
	
	
	"http://hrfcwnmp:h5842xrc9zzm@38.154.227.167:5868",
	"http://hrfcwnmp:h5842xrc9zzm@38.153.152.244:9594",
	"http://hrfcwnmp:h5842xrc9zzm@86.38.234.176:6630",
	"http://hrfcwnmp:h5842xrc9zzm@173.211.0.148:6641",
	"http://hrfcwnmp:h5842xrc9zzm@161.123.152.115:6360",
	
	"http://hrfcwnmp:h5842xrc9zzm@216.10.27.159:6837",
	"http://hrfcwnmp:h5842xrc9zzm@154.36.110.199:6853",
	"http://hrfcwnmp:h5842xrc9zzm@45.151.162.198:6600",
	"http://hrfcwnmp:h5842xrc9zzm@185.199.229.156:7492",
	"http://hrfcwnmp:h5842xrc9zzm@185.199.228.220:7300",


	/*'http://halusngj:iqii2z5mv1ke@38.154.227.167:5868',
	"http://tkifgotd:h5842xrc9zzm@38.154.227.167:5868",
	"http://tkifgotd:h5842xrc9zzm@38.153.152.244:9594",
	"http://tkifgotd:h5842xrc9zzm@86.38.234.176:6630",
	"http://tkifgotd:h5842xrc9zzm@173.211.0.148:6641",
	"http://tkifgotd:h5842xrc9zzm@161.123.152.115:6360",
	
	"http://tkifgotd:h5842xrc9zzm@216.10.27.159:6837",
	"http://tkifgotd:h5842xrc9zzm@154.36.110.199:6853",
	"http://tkifgotd:h5842xrc9zzm@45.151.162.198:6600",
	"http://tkifgotd:h5842xrc9zzm@185.199.229.156:7492",
	"http://tkifgotd:h5842xrc9zzm@185.199.228.220:7300",
	
	"http://83.168.72.172:8081",
	"http://185.132.242.212:8083",
	"http://80.249.112.163:80",
	"http://103.49.114.195:8080",
	"http://89.110.78.230:80",
	
	"http://79.110.200.27:8000",
	"http://79.110.201.235:8081",
	
	"http://83.168.74.163:8080",
	"http://93.171.157.249:8080",
	"http://203.74.125.18:8888",*/

	"http://43.153.25.185:13001",
	"http://43.153.61.52:13001",
	"http://43.153.91.13:13001",
	"http://43.153.85.114:13001",
	"http://43.153.2.82:13001",
	"http://43.153.7.172:13001",
	"http://31.40.248.2:8080",
	"http://139.59.1.14.2:80",
	"http://50.223.246.237:80",
	"http://50.174.7.159:80",
	"http://50.207.199.87:80",
	"http://32.223.6.94:80",
	"http://172.188.122.92:80",
	"http://13.38.153.36:80",
	"http://13.37.59.99:3128",
	
	"http://50.122.86.118:80",
	"http://188.68.52.244:80",
	"http://184.169.154.119:80",
	"http://13.56.192.187:80",
	
	
	"http://13.38.153.36:80",
	"http://13.36.104.85:80",
	"http://13.37.73.214:80",
	"http://44.195.247.145:80",
	"http://50.174.7.153:80",
	"http://165.232.129.150:80",
	"http://50.239.72.18:80",
	"http://50.217.226.47:80",
	"http://50.239.72.19:80",
	
	"http://50.221.74.130:80",
	"http://190.58.248.86:80",
	"http://203.115.101.51:82",
	"http://188.68.52.244:80",
	"http://184.169.154.119:80",
	"http://13.56.192.187:80",
	"http://4.145.89.88:8080",
	
	"http://85.215.64.49:80",
	"http://23.247.136.248:80",
	"http://13.208.56.180:80",
	"http://35.72.118.126:80",
	"http://3.71.239.218:3128",
	
	"http://35.76.62.196:80",
	"http://3.127.62.252:80",
	"http://18.228.149.161:80",
	
	"http://46.51.249.135:3128",
	"http://43.200.77.128:3128",
	"http://54.233.119.172:3128",
	
	"http://52.67.10.183:80",
	"http://200.250.131.218:80",
	"http://52.196.1.182:80",
	
	"http://204.236.176.61:3128",
	"http://3.130.65.162:3128",
	
	
	
	//'http://halusngj:iqii2z5mv1ke@38.154.227.167:5868',//'http://64.62.219.99:3128',
];


app.get('/image-json', async (req, res) => {
	res.write(JSON.stringify(jsonImages));
	res.end();
});


app.get('/json', async (req, res) => {
	res.write(JSON.stringify(jsonTickers));
	res.end();
});



//const proxy = 'http://64.62.219.99:3128';
app.get('/proxy', async (req, res) => {
	const targetUrl = req.query.url;


	// Set initial proxy
	let proxyIndex = 0;
	let proxy = proxyList[proxyIndex].includes('http') ? proxyList[proxyIndex] : "http://" + proxyList[proxyIndex];
	const proxyRetries = 5;
	let maxRetriesAttempt = proxyRetries;
	let agent = new HttpsProxyAgent(proxy);

	for (let loop = 0; loop < tickers.length; loop++) {
		let ticker = tickers[loop];
		
		let shouldLoop = true;
		let reply;
		
		res.write("TICKER: " + ticker + ' \n');
		res.write("Using proxy: " + proxy + ' \n');

		while (shouldLoop) {
			try {

				await delay(1000)
				await fetchWithTimeout(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&outputsize=full&apikey=dem`, {
					agent: agent,
				}, 15000).then(d => d.json()).then(async resp => {
					reply = resp;
					if (resp['Information']) {
						res.write(JSON.stringify(resp));
						shouldLoop = false;
						throw new Error("Error api exceed usage limits");
						//maxRetriesAttempt = 0;
						//throw new Error("Error api exceed usage limits");
					}
					
					if(resp['Error Message'] && resp['Error Message'].includes('Invalid API call')){
						shouldLoop = false;
						throw new Error("Skipping " + ticker);
					}
					
					if (!resp['Time Series (Daily)']) {
						res.write(JSON.stringify(resp));
						throw new Error("Error data not found");
					}

					let arr = [];
					for (const [date, values] of Object.entries(resp['Time Series (Daily)'])) {
						arr.push({
							d: date,
							o: values['1. open'],
							h: values['2. high'],
							l: values['3. low'],
							c: values['4. close'],
							v: values['5. volume']
						});
					}
					
					if(!arr.length)
						throw new Error("Error length is zero");



					let string = "";
					arr.forEach((values, index) => {
						string += values.d + "," + values.o + "," + values.h + "," + values.l + "," + values.c + "," + values.v;
						if (index !== arr.length - 1) {
							string += ";";
						}
					});

					let widthIndex = 0;
					let heightIndex = 0;

					let width = 800;
					let height = Math.ceil(string.length / 6 / width);

					// Fill up empty spaces
					let paddingCount = 6 - (string.length % 6);
					while (paddingCount--) {
						string += " ";
					}

					// Create a canvas element
					let canvas = createCanvas(width, height);

					// Get the 2D drawing context
					let ctx = canvas.getContext('2d');

					// Define a color (RGB) - white
					ctx.fillStyle = 'rgb(255, 255, 255)';

					// Fill the entire canvas with the color
					ctx.fillRect(0, 0, canvas.width, canvas.height);

					for (let i = 0; i < string.length; i += 6) {
						// Get RGB values from the encoded pixel data
						let red = ((getEncodedPixelData(string[i]) & 0xF) << 4) | (getEncodedPixelData(string[i + 1]) & 0xF);
						let green = ((getEncodedPixelData(string[i + 2]) & 0xF) << 4) | (getEncodedPixelData(string[i + 3]) & 0xF);
						let blue = ((getEncodedPixelData(string[i + 4]) & 0xF) << 4) | (getEncodedPixelData(string[i + 5]) & 0xF);

						// Set the pixel color
						ctx.fillStyle = `rgb(${red}, ${green}, ${blue})`;
						// console.log(`rgb(${red}, ${green}, ${blue})`)
						// Draw the pixel at the current position
						ctx.fillRect(widthIndex, heightIndex, 1, 1);

						// Move to the next pixel
						widthIndex++;
						if (widthIndex === width) {
							widthIndex = 0;
							heightIndex++;
						}
					}

					// Create a link to download the canvas as a PNG
					let base64Image = canvas.toDataURL('image/png');
					//res.write(base64Image);
					//return;


					const albumId = "w2q9yRA";//,"YcnD8zI";//'G0DQ6Hk'; // Imgur album ID
					const accessToken = 'ffc8fd46eb1f0d2bf28d099af47f421eb574bfa3'; // Imgur access token
					
					
					//res.write( JSON.stringify(dd) + `\n`);
					//res.write( base64Image + `\n`);
					
					//return;
					
					if(1){
						shouldLoop = false;
						jsonImages[ticker] = {
									"image-name": ticker + ".png",
									"ticker": ticker,
									"type": "daily",
									"from": arr[arr.length - 1]['d'],
									"to": arr[0]['d'],
						}
						createImageFile(ticker + ".png", base64Image);
					}
					
					// Temporarily bypass Imgur
					if(false){
						let dd = {
							"imgur-id": imageId,
							"ticker": ticker,
							"type": "daily",
							"from": arr[arr.length - 1]['d'],
							"to": arr[0]['d'],
						}
					
						let r = await uploadImageToImgur(base64Image, accessToken, JSON.stringify(dd));
						if (r['success']) {
							let imageId = r['data']['id'];
							res.write(`Image uploaded successfully. ID: ${imageId} \n`)
							jsonTickers[ticker] = {
									"imgur-id": imageId,
									"ticker": ticker,
									"type": "daily",
									"from": arr[arr.length - 1]['d'],
									"to": arr[0]['d'],
							};
							let albumR = await addImageToImgurAlbum(imageId, albumId, accessToken);

							if (albumR['success']) {
								res.write(`Image Album Added successfully \n`)
							} else {
								res.write(`Added album failed \n`)
							}
							shouldLoop = false;
						} else {
							res.write(`Image uploaded failed \n`)
							res.write(JSON.stringify(
								{
									base64Image:base64Image,
									description:dd,
								}
							));
							res.write(`\n`)
							shouldLoop = false;
						}
					}
				})


			} catch (error) {
				res.write(maxRetriesAttempt + ' Attempt : Error: ' + error.message + ' \n');
				res.write(JSON.stringify(reply) + ' \n');
				maxRetriesAttempt--;
			}
			
			if (maxRetriesAttempt <= 0) {
				if (proxyIndex === proxyList.length - 1){
					shouldLoop = false;
					res.write('All proxies failed \n');
					res.write(JSON.stringify(jsonTickers));
					res.end();
					return;
				}

				// Set next proxy
				maxRetriesAttempt = proxyRetries;
				proxyIndex++;
				proxy = proxyList[proxyIndex].includes('http') ? proxyList[proxyIndex] : "http://" + proxyList[proxyIndex];
				agent = new HttpsProxyAgent(proxy);
				res.write('Switched to proxy: ' + proxy + ' \n');
			}
		}

	}
	
	res.write(JSON.stringify(jsonTickers));
	res.end();
});
app.listen(3000, () => console.log('Server running on port 3000'));
