(()=>{var a=(a,b)=>a.reduce((a,c)=>a.then(a=>b(c).then(b=>a.concat([b]))),Promise.resolve([])),b=a=>{let b=new DataTransfer;return a.forEach(a=>b.items.add(a)),Object.defineProperty(b,"items",{value:a.map(a=>(a.getAsFile=()=>a,a))}),b},c=(a,b)=>document.documentElement.addEventListener(a,b,!0),d=(a,c)=>{let d=b(c);a.files=d.files},e=(b,c,d={},e={})=>{let{bubbles:f=!0,detail:g}=e,a=new CustomEvent(c,{bubbles:f,detail:g});return Object.assign(a,d),b.dispatchEvent(a),a},f=["x","y","screenX","screenY","layerX","layerY","pageX","pageY","offsetX","offsetY","clientX","clientY"],g=(g,{didIntercept:h,shouldHandleChange:i,shouldHandleDrop:j},k)=>{let l=(b,c)=>a(Array.from(b),a=>g(a,c));c("change",a=>{let{target:b}=a;if(b.ignoreChangeEvent||a.$cropguide)return;let c=i(a);c&&(h(a),a.stopImmediatePropagation(),l(b.files,c).then(a=>{k("processed selected files",a),b.ignoreChangeEvent=!0,d(b,a.filter(Boolean)),delete b.ignoreChangeEvent;let c=e(b,"change",{$cropguide:!0});k("dispatched CustomEvent",[b,c])}))}),c("drop",a=>{if(a.$cropguide)return;let c=j(a);if(!c)return;h(a);let{target:d}=a;a.preventDefault(),a.stopImmediatePropagation();let g=f.reduce((b,c)=>(b[c]=a[c],b),{});l(a.dataTransfer.files,c).then(a=>{k("processed dropped files",a);let c=b(a.filter(Boolean)),f=e(d,"drop",{...g,dataTransfer:{effectAllowed:"all",types:["Files"],files:c.files,items:c.items},$cropguide:!0},{bubbles:!0});k("dispatched CustomEvent",[d,f])})})},h=()=>window&&"DataTransfer"in window,_=(b,{parent:c,onerror:d})=>{let a=document.createElement("script");return a.defer=!0,a.async=!0,a.src=b,a.onerror=d,(c||document.head).append(a),a},i=a=>a&&/input/i.test(a.tagName)&&"file"===a.type,j=a=>a&&a.type&&/png|jpeg|gif|bmp|webp/.test(a.type),k=a=>!(!i(a.target)||!a.target.files.length||!Array.from(a.target.files).some(j)),l=a=>!(i(a.target)||!a.dataTransfer||!a.dataTransfer.files.length||!Array.from(a.dataTransfer.files).some(j)),m=a=>a.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."),n=a=>{let b=Date.now(),c="CropGuide";return a?(...a)=>{let e=`${m(Date.now()-b)}ms`.padStart(8," "),d="";"string"==typeof a[0]?(d=e+" "+c+" "+a[0],params=a.splice(1)):(d=e,params=[...a]),params.length?console.log(d,params):console.log(d)}:()=>{}},o="application/json",p=(a,b={},{method:c="GET"}={})=>Promise.resolve('{"status":"OK"}'),q=(b,a)=>{if("html"===a||b.matches(a))return!0;let c=document.querySelector(a);return!!c&&c.contains(b)},r=a=>new File([a],a.name,{type:a.type,lastModified:a.lastModified}),s=()=>{let[a,b,c]=getComputedStyle(document.documentElement).backgroundColor.match(/[0-9]+/g).map(a=>parseInt(a,10));return .2126*a+.7152*b+.0722*c>100},t=()=>{try{return"1"===localStorage.getItem("cgdebug")}catch(a){}};((c,m,{hookId:d,apiURL:o,localeURL:x,clientURL:y})=>{let f=new URL(m.currentScript.src).searchParams,u=null!==f.get("debug")||t(f),a=n(u);h();let v=f.get("c"),b=c[d],i=[];if(b){if(b.fields)i=b.fields.map(a=>"string"==typeof a?{selector:a}:a),c[d]=void 0,a("local fields config loaded",i);else if("object"==typeof b)return a("client already initialised")}let w=(a,b)=>e(m.documentElement,`${d}:${a}`,void 0,{detail:b});w("init"),a("init",v);let z,A,B,C,D=(a="auto")=>{if("auto"!==a)return a.toLowerCase()||"en";let b=(m.documentElement.lang||"en").substring(0,2).toLowerCase();return/^(en|es|fr|de|ru|zh)$/i.test(b)?b:"en"},E=(d,b,e)=>{if(!e(b))return a(`skip ${b.type} event`,b),!1;let c=d.find(({selector:a})=>q(b.target,a));return c&&(!c.field.disabled||u)?(a(`handle ${b.type} event`,b,c),c):(a(`skip ${b.type} event`,b),!1)},F=(b,a)=>({selector:a.selector,field:{...b.field,...a.field},editor:{...b.editor,...a.editor}}),G=()=>{let{banner:t}=z,d=i.length?i.map(a=>F(z.fields.find(b=>b.selector===a.selector)||z.fields.find(a=>"html"===a.selector),a)):z.fields;a("fields config",d);let u=s(),{userAgent:e,maxTouchPoints:f,platform:h}=navigator,n=/^mac/i.test(h),q=/iPhone|iPad|iPod/.test(e)||n&&f>=1;if(q){let b=m.createElement("style");b.textContent=".CropGuideDocumentLock,.CropGuideDocumentLock body {height: var(--crop-guide-document-height);overflow-y: hidden;box-sizing: border-box;}.CropGuideDocumentLock body {position:relative;}.CropGuideDocumentLock .CropGuideFrame {height: 100% !important;}",m.head.append(b)}let x,y=()=>m.documentElement.style.setProperty("--crop-guide-document-height",`${window.innerHeight}px`),D=()=>{a("will show editor"),C.style.pointerEvents="all",C.style.width="100%",C.style.height="100vh",q&&y()},G=()=>{a("did show editor"),w("open"),q&&(void 0===x&&(x=c.scrollY),m.documentElement.classList.add("CropGuideDocumentLock"),y(),c.addEventListener("resize",y))},H=()=>{a("will hide editor"),q&&(c.removeEventListener("resize",y),m.documentElement.classList.remove("CropGuideDocumentLock"),c.scrollTo(0,x),x=void 0)},I=()=>{a("did hide editor"),w("close"),C.style.pointerEvents="none",C.style.width=0,C.style.height=0};g((b,c)=>new Promise(d=>{if(!j(b))return a("ignore",b),w("ignore",{src:b}),d(b);a("edit",b),B(b,{log:a,env:{locale:A,banner:t,pageIsBright:u,willShowEditor:D,didShowEditor:G,willHideEditor:H,didHideEditor:I},requirements:c}).then(e=>{let c=r(e);a("processed",c),p(`${o}`,{clientId:v}),w("process",{src:b,dest:c}),d(c)}).catch(c=>{let e=c;c.hasOwnProperty("message")?e={error:c.message+" "+c.stack}:"string"==typeof c&&(e={error:c});let{error:$}=e;if(/image too small/i.test($))return a("image too small",b),w("invalid",{src:b}),d();a("error",$),p(`${o}/report`,{clientId:v,error:$}),w("error",{src:b,error:$}),d(b)})}),{didIntercept:a=>w("intercept",a),shouldHandleChange:a=>E(d,a,k),shouldHandleDrop:a=>E(d,a,l)},a),w("load")},H=(b,c,d)=>{if(!b){a(`wait for ${c} to load`);return}d()};c[d]={_setLocale(b){a("locale loaded",b),A=b,H(B,"editor",G)},_setEditor(b){a("client loaded"),B=b,H(A,"locale",G)}},a("load config",o),new Promise((a,b)=>{a('{"fields":[{"selector":"html","field":{"theme":"auto","enableHeadlessMode":false,"disabled":false,"guide":"none","mask":"none"},"editor":{"imageCropAspectRatio":"1","imageBackgroundcolor":null,"imageWriter":{"targetSize":{"width":1024,"height":1024,"fit":"contain","upscale":false},"mimeType":null,"quality":98},"imageCropMinSize":{"width":1,"height":1},"cropSelectPresetOptions":null,"cropSelectPresetOptionsValueModel":"[]"}}],"locale":"en","banner":true,"status":"OK"}')}).then(c=>{a("config loaded");try{z=JSON.parse(c,(b,a)=>null===a?void 0:a)}catch(e){a("failed to parse config",c);return}if(a("config parsed",z),"Inactive"===z.status){a("inactive",z);return}let b=D(z.locale);a("inject locale",x,b),_(x+`/${b}.js`,{onerror:b=>a("locale inject error",b||{})});let d="html .pintura-editor{--color-primary:#6418e6;--color-primary-dark:#4e18aa;--color-primary-text:#faf7ff} html .pintura-editor .PinturaButtonExport{color:rgb(var(--color-background))!important;background:rgb(var(--color-foreground))!important}";(C=m.createElement("iframe")).onerror=b=>a("iframe load error",b),C.allowtransparency=!0,C.className="CropGuideFrame",C.style.cssText="position:fixed;left:0;top:0;width:0;height:0;border:0;z-index:2147483647;pointer-events:none;touch-action:manipulation;user-select:none;",a("inject client",y),C.srcdoc='<!DOCTYPE html><html lang="'+b+'"><meta charset="utf-8"><title>crop.guide</title><style>'+d+'</style><script src="'+y+'"></script></html>',a("append client frame"),m.body.append(C)}).catch(b=>a("config load error",b))})(window,document,{hookId:"$cropguide",apiURL:"https://app.crop.guide/api",localeURL:"https://cdn.jsdelivr.net/gh/marcustansoon/PhysicsEngine.js-2D@master/crop.guide/locale",clientURL:"https://cdn.jsdelivr.net/gh/marcustansoon/PhysicsEngine.js-2D@master/crop.guide/l.js"})})()
